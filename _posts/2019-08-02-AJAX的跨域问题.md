---
layout: post
title: 'AJAX的跨域问题'
date: 2019-08-02
author: yamadadada
color: red
cover: 'https://gss1.bdstatic.com/9vo3dSag_xI4khGkpoWK1HF6hhy/baike/c0%3Dbaike80%2C5%2C5%2C80%2C26/sign=f278371e37d12f2eda08a6322eabbe07/c995d143ad4bd113fa64e1fb5bafa40f4afb0549.jpg'
tags: ajax
typora-root-url: ..
---

## 为什么会有跨域问题的出现

跨域通常情况下是说在两个不同的域名之间无法进行正常的通信，或者说是无法获取其他域名下面的资源，因为浏览器采用了**同源策略**

## 同源策略

同源策略，它是由Netscape提出的一个著名的安全策略。   

现在所有支持JavaScript 的浏览器都会使用这个策略。

### 同源的定义

所谓同源指的是，协议、域名、端口号都相同，只要有一个不相同，那么都是非同源。

![img](/assets/44.png)

### 不同源会怎样？

- 无法用js读取非同源的Cookie、LocalStorage 和 IndexDB 无法读取。
- 无法用js获取非同源的DOM 。
- 无法用js发送非同源的AJAX请求 。更准确的说，js可以向非同源的服务器发请求，但是服务器返回的数据会被浏览器拦截。

### 是谁来执行同源策略的？

同源策略是由浏览器来执行。所有的限制都是浏览器的作用。这是浏览器为了保护用户的数据安全而采取的策略。

### 同源策略如何保护用户数据安全？

#### （1） 无法用js读取非同源的Cookie、LocalStorage 和 IndexDB 无法读取。

为了防止恶意网站通过js获取用户其他网站的cookie。

#### （2） 无法用js获取非同源的DOM 。

如果没有这一条，恶意网站可以通过iframe打开银行页面，可以获取dom就相当于可以获取整个银行页面的信息。

#### （3） 无法用js发送非同源的AJAX请求 。

假设有一个黑客叫做小黑，他从网上抓取了一堆美女图做了一个网站，每日访问量爆表。
 为了维护网站运行，小黑挂了一张收款码，觉得网站不错的可以适当资助一点，可是无奈伸手党太多，小黑的网站入不敷出。
 于是他非常生气的在网页中写了一段js代码，使用ajax向淘宝发起登陆请求，因为很多数人都访问过淘宝，所以电脑中存有淘宝的cookie，不需要输入账号密码直接就自动登录了，然后小黑在ajax回调函数中解析了淘宝返回的数据，得到了很多人的隐私信息，转手一卖，小黑的网站终于盈利了。
 如果跨域也可以发送AJAX请求的话，小黑就真的获取到了用户的隐私并成功获利了！！！

#### （4）总结

用form表单提交到不同源的网页是被允许的，因为 form 提交到另一个域名之后，原页面的脚本无法获取新页面中的内容,所以浏览器认为这是安全的。

  而 AJAX 是可以读取响应内容的，因此浏览器不能允许你这样做。如果你细心的话你会发现，其实请求已经发送出去了，你只是拿不到响应而已。

所以浏览器这个策略的本质是，一个域名的 JS ，在未经允许的情况下，不得读取另一个域名的内容。但浏览器并不阻止你向另一个域名发送请求。

## **在日常的开发中，如何解决跨域问题?**

先举个简单的例子来说下遇到的问题，比如www.news.baidu.com和www.map.baidu.com两个网页一级域名相同，只是二级域名不同，被认为不同源，但是开发者希望登录信息cookie共享。

首先浏览器允许通过设置document.domain共享 Cookie。前端可以设置相同的document.domain，两个网页就可以共享Cookie了。

另外，服务器也可以在设置Cookie的时候，指定Cookie的所属域名为一级域名，比如.baidu.com。这样的话，二级域名和三级域名不用做任何设置，都可以读取这个Cookie。

这种方式只适合主域名相同，但子域名不同的iframe跨域。那么不同窗口不同页面的跨域通讯如果处理。

### **1、架设服务器代理，浏览器请求同源服务器，再由后者（比如Nginx）请求外部服务**

### 2、**JSONP**

JSONP是服务器与客户端跨源通信的常用方法。最大特点就是简单适用，老式浏览器全部支持，服务器改造非常小。上面讲到在HTML标签里，一些标签比如script、img这样的获取资源的标签是没有跨域限制的，利用这一点，我们可以这样干

![img](/assets/45.png)

JSONP只能发GET请求，因为本质上script加载资源就是GET请求，但JSONP也可以利用form发起post请求

### 3、**WebSocket**

WebSocket是一种通信协议，使用ws://（非加密）和wss://（加密）作为协议前缀。该协议不实行同源政策，只要服务器支持，就可以通过它进行跨源通信。浏览器发出的WebSocket请求的头信息中有一个字段是Origin，用于表示该请求的请求源，即发自哪个域名，服务器可以根据这个字段，判断是否许可本次通信。

### 4、**CORS**

 CORS是跨源资源分享（Cross-Origin Resource Sharing）的缩写。它是W3C标准，是跨源AJAX请求的根本解决方法。相比JSONP，CORS允许任何类型的请求。在使用CORS来访问数据的时候，客户端不需要更改任何数据访问逻辑。所有的一切工作都是在服务端及浏览器之间自动完成的。因此如果希望为一个系统集成CORS支持的时候，我们需要做的工作主要集中在服务端。使用Filter 处理跨域请求，服务端可以进行一些配置，其中Access-Control-Allow-Origin和Access-Control-Allow-Methods字段是必填的，还有些其他的配置比如是否允许发送Cookie等，这边就不多说了。

​    Access-Control-Allow-Origin：它的值要么是请求时Origin字段的具体值，要么是一个*，表示接受任意域名的请求

​    Access-Control-Allow-Methods：它的值是逗号分隔的一个具体的字符串或者*，表明服务器支持的所有跨域请求的方法。 